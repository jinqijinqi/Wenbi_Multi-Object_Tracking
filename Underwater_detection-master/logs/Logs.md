# 模型修改日志

[toc]

## Faster Rcnn overview

| date       | MAP       | MAP50     | MAP75     | s         | m         | l         | score          | loss     |
| ---------- | --------- | --------- | --------- | --------- | --------- | --------- | -------------- | -------- |
| 3/10_3     | 0.499     | 0.853     | 0.533     | 0.253     | 0.463     | 0.553     | 0.45975257     | 0.39     |
| **3/10_1** | **0.500** | **0.851** | **0.536** | **0.248** | **0.470** | **0.553** | **0.46365661** | **0.24** |
| 3/9_2      | 0.490     | 0.842     | 0.524     | 0.242     | 0.463     | 0.540     | 0.44945764     | 0.21     |
| 3/8_3      | 0.474     | 0.839     | 0.486     | 0.232     | 0.446     | 0.527     | 0.43323416     | 0.2      |
| 3/8_2      | 0.462     | 0.832     | 0.463     | 0.223     | 0.441     | 0.508     | 0.42316451     | 0.2      |
| 3/8_1      | 0.467     | 0.834     | 0.475     | 0.218     | 0.446     | 0.516     | 0.42315355     | 0.21     |
| 3/6        | 0.465     | 0.833     | 0.465     | 0.229     | 0.44      | 0.513     | 0.42745937     | 0.22     |

| data       | bb      | lr       | ep     | anchro_ratio          | 多尺度训练                    | nms_thr             | OHEM  |
| ---------- | ------- | -------- | ------ | --------------------- | ----------------------------- | ------------------- | ----- |
| 3/10_3     | r50     | 0.02     | 12     | [.2, .5, 1, 2, 5]     | (4096, 800), (4096, 1200)     | 0.001(soft_nms)     | √     |
| **3/10_1** | **r50** | **0.02** | **12** | **[.2, .5, 1, 2, 5]** | **(4096, 800), (4096, 1200)** | **0.001(soft_nms)** | **×** |
| 3/9_2      | r50     | 0.02     | 12     | [.2, .5, 1, 2, 5]     | (1333, 800)(1333, 1200)       | 0.001(soft_nms)     | ×     |
| 3/8_3      | r50     | 0.02     | 12     | [.2, .5, 1, 2, 5]     | (1333, 800)(1333, 1200)       | 0.05                | ×     |
| 3/8_2      | r50     | 0.02     | 12     | [ .5, 1, 2]           | (1080, 920)                   | 0.05                | ×     |
| 3/8_1      | r50     | 0.02     | 12     | [.2, .5, 1, 2, 5]     | (1080, 920)改为dcn权重        | 0.05                | ×     |
| 3/6        | r50     | 0.02     | 12     | [.2, .5, 1, 2, 5]     | (1080, 920)                   | 0.05                | ×     |

## Cascade overview

| date       | MAP       | MAP50     | MAP75     | s         | m         | l         | score          | loss     |
| ---------- | --------- | --------- | --------- | --------- | --------- | --------- | -------------- | -------- |
| **3/10_2** | **0.498** | **0.836** | **0.540** | **0.242** | **0.464** | **0.553** | **0.45107298** | **0.65** |
| 3/9_1      | 0.481     | 0.821     | 0.518     | 0.237     | 0.457     | 0.528     | 0.43794168     | 0.68     |
| 3/7        | 0.413     | 0.722     | 0.425     | 0.179     | 0.395     | 0.452     | 0.36510317     | 0.66     |
| 3/5        | 0.401     | 0.689     | 0.433     | 0.149     | 0.367     | 0.462     | 0.34733043     | 0.89     |
| 3/4        | 0.405     | 0.702     | 0.429     | 0.157     | 0.372     | 0.468     | 0.35986083     | 1.0      |
| 3/3        | 0.475     | 0.832     | 0.497     | 0.224     | 0.448     | 0.528     | 0.39238524     | 0.6      |

| data       | bb      | lr       | ep     | anchro_ratio      | 多尺度训练                   | nms_thr            | dcn   | OHEM  |
| ---------- | ------- | -------- | ------ | ----------------- | ---------------------------- | ------------------ | ----- | ----- |
| **3/10_2** | **r50** | **0.02** | **12** | **[.5, 1, 2]**    | **(4096, 800), (4096,1200)** | **.001(soft_nms)** | **×** | **×** |
| 3/9_1      | r50     | 0.02     | 12     | [.2, .5, 1, 2, 5] | (4096, 800), (4096,1200)     | .001(soft_nms)     | √     | ×     |
| 3/7        | r50     | 0.02     | 12     | [.2, .5, 1, 2, 5] | (1920, 1080), (720, 405)     | 0.5                | √     | ×     |
| 3/5        | r101    | 0.04     | 22     | [.2, .5, 1, 2, 5] | (1080, 920)                  | 0.5                | √     | √     |
| 3/4        | r50     | 0.02     | 12     | [.2, .5, 1, 2, 5] | (1080, 920)                  | 0.5                | √     | √     |
| 3/3        | r50     | 0.02     | 12     | [.2, .5, 1, 2, 5] | (1080, 920)                  | 0.5                | √     | ×     |

+ 前期受到了nms的影响，提高了预测的nms的阈值，导致coco方法计算map时普遍降低
+ 确实尺度越大准确率越高

## 20200303

**Config**

| baseline                 | lr   | step    | anchor_ratios             | ima_scale   |
| ------------------------ | ---- | ------- | ------------------------- | ----------- |
| cascade_rcnn_dcn_r50_fpn | 0.02 | [8, 11] | [0.2, 0.5, 1.0, 2.0, 5.0] | (1080, 920) |

+ 观测数据，发现数据集多呈序列分布，若用随机抽样可能会因场景分布产生误差，故采用间隔抽样，按照0.85：0.15的比例切分训练集和验证集

+ 验证序列抽样后，训练集、验证集、原始数据集各目标分布基本保持不变

| dataset | holothurian | echinus | scallop | starfish |
| ------- | ----------- | ------- | ------- | -------- |
| org     | 5537        | 22343   | 6720    | 6814     |
| train   | 4574        | 18676   | 5554    | 5704     |
| val     | 963         | 3667    | 1166    | 1137     |

+ 针对图像大小分布情况，当时选取了靠近(720,405)，且略大的分辨率，mmdet保持比例不变

  ![1583591299153](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1583591299153.png)

这里疑似会出问题，若图像大小为(3840,2160)，resize到(1080, 920)，图像缩小3.5倍，可能会删除较小标注框

结果图

![1583592005705](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1583592005705.png)

**结论：**

1. 修改学习率意义不大，模型拟合较好，map和损失都较早趋于稳定

## 20200304

**Config**

| baseline                 | lr   | step    | anchor_ratios             | ima_scale   |
| ------------------------ | ---- | ------- | ------------------------- | ----------- |
| cascade_rcnn_dcn_r50_fpn | 0.02 | [8, 11] | [0.2, 0.5, 1.0, 2.0, 5.0] | (1080, 920) |

+ 引入了OHEM，在线难样本挖掘，在cascade的三个阶段。本想使用focal loss，但focal loss的根本目的是解决one-stage中，正负样本分布不均衡，简单负样本过多，导致模型收敛更快，但却没有很好拟合困难正样本的知识。使用的cascade网络，本身是two-stage，已经解决了正负样本分布不均衡的问题
+ 其他什么都没有改，模型在验证集下降了0.07个点，在平台得分下降了0.04个点，**OHEM不是直接改了就能用，需要读一下原文，了解适用环境**

![1583592621770](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1583592621770.png)

**结论：**

1. 看loss曲线，模型欠拟合，且下降幅度较小，感觉可以略微提高学习率，增加训练epoch
2. 引入OHEM，损失先上升，后下降。map的起点精度均降低 (mAP: 0.34 ->0.22)

## 20200305

**Config**

| baseline                 | lr   | step     | anchor_ratios             | ima_scale   |
| ------------------------ | ---- | -------- | ------------------------- | ----------- |
| cascade_rcnn_dcn_r50_fpn | 0.04 | [16, 19] | [0.2, 0.5, 1.0, 2.0, 5.0] | (1080, 920) |

+ backbone换成了 ResNet101
+ 采样器依然是OHEMSampler
+ 提高学习率0.02->0.04
+ 增加了训练周期到22个epoch

![1583593178075](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1583593178075.png)

**总结：**

1. 1-5个epoch，使用四个GPU，一个epoch迭代285次
   6-22个epoch，使用两个GPU，一个epoch迭代570次
2. 增大学习率，算法在1-5个epoch损失下降于4日相比没有明显变化，均为1.2左右。提高了学习率网络并非收敛更快，反而更早的趋于稳定，感觉学习率给大了，学习率降低后，网络还是可以降到0.9的损失，**且mAP与4日差别不大**，**ResNet从50->101，没有发挥作用，OHEM没有配合默契，限制了模型表达**
3. mAP起点更低，在第16个epoch更新学习率，损失有明显下降，MAP有明显提升，但随后趋于稳定，在第19个epoch更新学习率，从损失上看略早，**还可以延后**，学习率降低后，网络趋于稳定，可能是train不动了

## 20200306

**Config**

| baseline                | lr   | step    | anchor_ratios             | ima_scale   |
| ----------------------- | ---- | ------- | ------------------------- | ----------- |
| faster_rcnn_dcn_r50_fpn | 0.02 | [8, 11] | [0.2, 0.5, 1.0, 2.0, 5.0] | (1080, 920) |

+ 原基础上加了anchor_ratios = [0.2, 0.5, 1.0, 2.0, 5.0]
+ 使用RandomSampler作为抽样器，未修改
+ 训练尺度，使用当前最优尺度(1080, 920)
+ 预训练权重使用的faster_rcnn_r50_fpn_1x_cls_24.pth，并非dcn的权重

![1583595721774](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1583595721774.png)

**总结：**

1. faster-rcnn损失起点更低，但是这与cascade的损失没有对比意义
2. 在第8个epoch调整学习率（4600次iter左右），损失有略微下降，第11次修改学习率，损失基本不变，模型拟合较好
3. 在第8个epoch调整学习率，map有略微升高，后趋于稳定
4. 这是目前最优baseline，考虑在此基础上做两个试验
   + **使用dcn的预训练权重，其他参数不变  --1**  基本曲线没变化
   + **使用原始ratio，其他参数不变     --2**
   + **使用多尺度训练，只修改短边，多尺度使用推荐尺度(1300, 1200)  (1300, 800)  测试使用(1300,1000) --3**

## 20200307

**Config**

| baseline                 | lr   | step    | anchor_ratios             | ima_scale                |
| ------------------------ | ---- | ------- | ------------------------- | ------------------------ |
| cascade_rcnn_dcn_r50_fpn | 0.02 | [8, 11] | [0.2, 0.5, 1.0, 2.0, 5.0] | (1920, 1080), (720, 405) |

+ 使用初始的cascade_r50训练
+ 使用RandomSampler作为抽样器，未修改
+ 添加了多尺度训练，使用两个尺度img_scale=[(1920, 1080), (720, 405)]， 测试的是scale使用的(1920, 1080)
+ 加载的预训练文件出现问题，加载的r101的预训练文件cascade_rcnn_dconv_c3-c5_r101_fpn_1x

![1583596919791](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1583596919791.png)

**总结：**

1. 经过eda， (720, 405)的图像更多，使用img_scale=[(1920, 1080), (720, 405)]，会导致部分图像缩放
2. 与3月3日对比，多尺度下，网络的损失起点更低
3. 在第七次更新学习率时，网络的损失还在下降，网络还没稳定，应延后调整学习率
4. 但从map来看，网络最终趋于稳定

## 20200308对照试验

**Config**

| baseline   | lr   | step    | anchor_ratios             | ima_scale   |
| ---------- | ---- | ------- | ------------------------- | ----------- |
| FasterRCNN | 0.02 | [8, 11] | [0.2, 0.5, 1.0, 2.0, 5.0] | (1080, 920) |

+ 20200306的对照组试验，使用了dcn训练权重faster_rcnn_dconv_c3-c5_r50_fpn_1x

![1583675087773](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1583675087773.png)

**总结：**

+ 与使用faster_rcnn_r50_fpn_1x_cls_24.pth对比，loss下降曲线基本完全一致
+ 使用dcn，更契合的权重后，Map起始有些下降，其他曲线基本与之前一致
+ **结果差距不大**，解释：其实有一个较好的权重初始就够了，后面有多轮的训练，都会让网络趋向于收敛

---

**Config**

| baseline   | lr   | step    | anchor_ratios   | ima_scale   |
| ---------- | ---- | ------- | --------------- | ----------- |
| FasterRCNN | 0.02 | [8, 11] | [0.5, 1.0, 2.0] | (1080, 920) |

+ 使用原始ratio，其他参数不变

![1583679520091](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1583679520091.png)

**总结：**

+ 改为初始ration[0.5, 1, 2]，MAP,MAP50,MAP75,S,M,L，六项指标均有所下降，总得分下降
+ anchor多尺度还是有意义的

---

**Config**

| baseline   | lr   | step    | anchor_ratios             | ima_scale               |
| ---------- | ---- | ------- | ------------------------- | ----------------------- |
| FasterRCNN | 0.02 | [8, 11] | [0.2, 0.5, 1.0, 2.0, 5.0] | (1333, 800)(1333, 1200) |

+ 使用官方标准多尺度训练，训练尺度(1333,1200)(1333,800)，测试尺度取短边中值(1333,1000)其他参数不变

![1583679878973](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1583679878973.png)

+ MAP75 MAP_S(<32*32),MAP_M(32 * 32 < s< 96*96),MAP_I(<96 *96)均上升0.01-0.02个点，说明多尺度训练，让网络对不同尺度的目标检测效果更好

**Case**



## 20200309

**Config**

| baseline                 | lr   | step    | anchor_ratios             | ima_scale                 |
| ------------------------ | ---- | ------- | ------------------------- | ------------------------- |
| cascade_rcnn_dcn_r50_fpn | 0.02 | [8, 11] | [0.2, 0.5, 1.0, 2.0, 5.0] | (4096, 800), (4096, 1200) |

+ 使用nms_soft修改预测阈值，提高对于遮挡的鲁棒性
+ 提高尺度长边上限。选取样本集样本最大长宽比，将短边限制为800-1200，将长边按照样本集最大比例缩放。再GPU容量足够，且未达到速度容忍度时，短边可提高限制
+ score_thr 从0.5改为0.001

![1583757891581](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1583757891581.png)

---

**Config**

| baseline | lr   | step    | anchor_ratios             | ima_scale                 |
| -------- | ---- | ------- | ------------------------- | ------------------------- |
| faster   | 0.02 | [8, 11] | [0.2, 0.5, 1.0, 2.0, 5.0] | (1333, 1200), (1333, 800) |

+ 使用nms_soft修改预测阈值，提高对于遮挡的鲁棒性

![1583758287656](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1583758287656.png)

## 20200310

**Config**

| baseline | lr   | step    | anchor_ratios             | ima_scale                 |
| -------- | ---- | ------- | ------------------------- | ------------------------- |
| faster   | 0.02 | [8, 11] | [0.2, 0.5, 1.0, 2.0, 5.0] | (4096, 800), (4096, 1200) |

+ 修改了多尺度训练的参数

![1583772207178](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1583772207178.png)

---

**Config**

| baseline    | lr   | step    | anchor_ratios   | ima_scale                 |
| ----------- | ---- | ------- | --------------- | ------------------------- |
| CascadeRCNN | 0.02 | [8, 11] | [0.5, 1.0, 2.0] | (4096, 800), (4096, 1200) |

+ 复现群内大神结果
+ 删除FCN
+ anchor_ratios=[0.5, 1.0, 2.0]
+ 测试配置中加入了随机旋转

![1583817792570](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1583817792570.png)

---

**Config**

| baseline | lr   | step    | anchor_ratios             | ima_scale                 |
| -------- | ---- | ------- | ------------------------- | ------------------------- |
| faster   | 0.02 | [8, 11] | [0.2, 0.5, 1.0, 2.0, 5.0] | (4096, 800), (4096, 1200) |

+ 在0310_1的基础上添加了OHEM

![1583819552453](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1583819552453.png)

## 20200312

针对（1317,1079,3）的图，

服务器跑cv2的高斯滤波，第一张图需要20.4s

笔记本跑需要近50s

使用图像金字塔滤波，多尺度滤波只需要0.18199s

![1584368673598](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1584368673598.png)

使用图像金字塔滤波，单尺度只需要0.05s

![1584368760018](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1584368760018.png)

必须用cython或者用torch的卷积改写

```python
cv2.GaussianBlur(img, (0, 0), self.sigma)
```



单尺度 对于double型图像 size为100  处理时间为0.39s 针对1317,1079的图

![1584100226457](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1584100226457.png)

单尺度 对于double型图像 size为200  处理时间为7s 针对1317,1079的图

![1584102699456](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1584102699456.png)

单尺度 对于double型图像 size为500  处理时间为7s 针对1317,1079的图

![1584102900836](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1584102900836.png)

不同的高斯kernel对图像的影响。sigma = 300，使用GIMP的MSRCR算法，单尺度，Dynamic = 2

高斯模糊在这里主要起到模拟光照成像，认为光照的成像是稳定的，变化是缓慢的，是低频的，对应背景和轮廓。所以用低通滤波器

sigma确定时，kernel的size越大，生成的图像越模糊，频带更窄，阻碍了高频，原图-生成的图(留下低频背景轮廓) = 那么相减，得到的就是滤过的高频细节，剪掉轮廓，图像更清晰

sigma确定时，kernel的size越小，生成的图像越清晰，频带更宽，通过了高频，原图-生成的图(滤掉少量的高频) = 那么相减，得到的就是滤过的少量的高频细节和噪声   相当于高通

在这个问题中，size越大，得到的低频更纯净（高频阻碍的越多）-> 模拟的低频稳定光照成像更完美
size越小，得到的低频混杂更多高频（高频阻碍的少）—> 模拟的低频稳定光照杂质细节更多，相减就生下了少量的细节，如图2

![1584192507227](C:\Users\60155\AppData\Roaming\Typora\typora-user-images\1584192507227.png)

> 高斯滤波：
>
> kernel_size固定的情况下，
> 频域：时域sigma越大，变换后频域sigma越小，频带越窄，阻碍更多高频细节噪声，图像越模糊
> 图像：权值分布越平缓，频带越宽，领域各个点的值对输出值影响越大，通过保留的频率越多，图像越模糊
>
> 频域：时域sigma越小，变换后频域sigma越大，频带越宽，通过更多的高频细节噪声，图像相对尖锐
> 图像：权值分布越突起，频带越窄，领域各个点的值对输出值影响越小，滤除的高频成分越多，图像变换较小
>
> sigma固定时，
> 核越大图像越模糊，
> 核越小图像变化越小，相对更尖锐
>
> 高斯函数的实现
>
> 由于高斯函数的可分离性，较大尺寸的高斯滤波器可以得以有效地实现．二维高斯函数卷积可以分两步来进行，首先将图像与一维高斯函数进行卷积，然后将卷积结果与方向垂直的相同一维高斯函数卷积．因此，二维高斯滤波的计算量随滤波模板宽度成线性增长而不是成平方增长．
>
> 核大对应频率低 核小对应频率高

因为当高斯函数的sigma等于300的时候，滤波器的大小大概在1801左右，直接对图像滤波，速度会很慢，最重要的是，需要补大量的padding，使图像失真

方法：给出任意大小的sigma值，都可以通过使用**图像金字塔**与**可分离滤波器**计算高斯卷积；

（1）使用图像金字塔，使用5*5的高斯滤波器，逐层对高斯金字塔滤波，并下采样，下采样后，sigma减半，用于下一层滤波

（2）不断递归，直到由sigma算出来的滤波器的size小于10

（3）当递归到，滤波器的大小小于10后，分x轴y轴对对应的下采样图进行高斯运算，这个图是经过一次次高斯模糊降采样得到的。

（4）反向逐层上采样，得到与输入原图同样分辨率，滤波结束

需要用多尺度的MSR，因为当图很小的时候，大的sigma产生的滤波器无法对图像滤波